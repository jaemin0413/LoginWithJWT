# 워크플로우의 이름
name: CI - Build and Push Docker Image to Docker Hub

# 워크플로우 트리거 -> main 브랜치에 푸쉬할 때
on:
  push:
    branches: [ "main" ]

# 실행될 작업 정의
jobs:
  build-and-push:
    name: Build and Push to Docker Hub
    # 작업이 실행될 환경
    runs-on: ubuntu-latest

    steps:
      # 1. 소스 코드 가져오기
      - name: Check out the repo
        uses: actions/checkout@v4

      # 2. JDK 17 설정
      - name: Set up JDK 17 with Gradle cache
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'gradle' # gradle 의존성 캐싱, 이거 안 하면 한 번 받은 라이브러리는 캐시해두고 다음엔 바로 사용.
                          # 이거 안 하면 할 때마다 gradle 다 뒤져서 다운받아야 함

      # 3. 실행 권한 추가 및 빌드
      - name: Grant execute permission for gradlew
        run: chmod +x gradlew
      - name: Build with Gradle
        run: ./gradlew bootJar --no-daemon

      # 4. Docker Buildx 설정 ( Docker 캐시를 위함)
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # 5. Docker Hub 로그인
      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # 6. Docker 이미지 빌드 및 푸시 ( 캐시 옵션 추가)
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/loginWithJWT:latest
          #  Docker 레이어 캐시 설정
          cache-from: type=gha,mode=max
          cache-to: type=gha,mode=max
          # 이러면 변경된 부분만 새로 빌드함
